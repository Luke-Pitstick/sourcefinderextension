import{r as a,j as t,c as T,R as k}from"./client-B9F7oGqJ.js";const h="Listening for claims...";async function C(){var e;const s=(e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:e.id;return Number.isInteger(s)?s:null}async function y(n){return await navigator.clipboard.writeText(n),"Copied to clipboard."}function L(n){const s=Math.round(n*100);return s>=80?`High ${s}%`:s>=65?`Medium ${s}%`:`Low ${s}%`}function A(n){return n>=.8?"high":n>=.65?"medium":"low"}function E(n){return new Date(n).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}function M(n){return n==="loading"?{label:"Scanning",tone:"loading"}:n==="error"?{label:"Attention",tone:"error"}:n==="ready"?{label:"Ready",tone:"ready"}:{label:"Standby",tone:"idle"}}function I({suggestion:n,onCopied:s}){const e=n.authors.length>0?n.authors.join(", "):"Unknown authors",d=[n.venue,n.year].filter(Boolean).join(" â€¢ ")||"Unknown venue";return t.jsxs("article",{className:"source-card",children:[t.jsxs("header",{className:"source-card-header",children:[t.jsx("p",{className:`confidence-pill ${A(n.confidence)}`,children:L(n.confidence)}),t.jsx("h3",{children:n.title}),t.jsxs("div",{className:"source-metadata",children:[t.jsx("p",{className:"source-meta",children:e}),t.jsx("p",{className:"source-meta muted",children:d})]})]}),n.why?t.jsxs("p",{className:"why",children:["Why: ",n.why]}):null,n.abstractSnippet?t.jsx("p",{className:"abstract",children:n.abstractSnippet.slice(0,260)}):null,t.jsxs("div",{className:"actions",children:[t.jsx("button",{type:"button",onClick:()=>{y(n.inTextCitation).then(s)},children:"Copy In-Text"}),t.jsx("button",{type:"button",onClick:()=>{y(n.bibliographyCitation).then(s)},children:"Copy Reference"}),t.jsx("button",{type:"button",className:"ghost",onClick:()=>{chrome.tabs.create({url:n.url})},children:"Open Source"})]})]})}function N({title:n,description:s}){return t.jsxs("div",{className:"empty-state",children:[t.jsx("p",{className:"empty-title",children:n}),t.jsx("p",{children:s})]})}function U(){const[n,s]=a.useState(null),[e,d]=a.useState(null),[m,o]=a.useState(h),[f,x]=a.useState(!1),p=a.useRef(null);a.useEffect(()=>{const r=chrome.runtime.connect({name:"SIDEPANEL"});p.current=r;const i=l=>{l.type!=="SUGGESTIONS_UPDATED"||!l.payload||n!==null&&l.payload.tabId!==n||d(l.payload)};return r.onMessage.addListener(i),()=>{r.onMessage.removeListener(i),r.disconnect(),p.current=null}},[n]),a.useEffect(()=>{const r=async()=>{var b;const c=await C();if(s(c),c===null){d(null);return}(b=p.current)==null||b.postMessage({type:"SUBSCRIBE_TAB",tabId:c});const u=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:c});u&&d(u)};r();const i=()=>{r()},l=(c,u)=>{u.status==="complete"&&c===n&&r()};return chrome.tabs.onActivated.addListener(i),chrome.tabs.onUpdated.addListener(l),()=>{chrome.tabs.onActivated.removeListener(i),chrome.tabs.onUpdated.removeListener(l)}},[n]);const v=a.useMemo(()=>e?e.status==="loading"?"Searching for supporting sources...":e.status==="error"?e.error||"Could not load source suggestions.":e.status==="ready"&&e.suggestions.length===0?"No confident sources found for the latest claim.":e.status==="ready"?`Found ${e.suggestions.length} sources for the latest claim.`:e.status==="idle"&&e.error?e.error:m:"Open Google Docs or Word web to start.",[e,m]),S=(e==null?void 0:e.status)==="ready"&&e.suggestions.length>0,j=M(e==null?void 0:e.status),w=async()=>{if(n===null){o("Open a Docs or Word tab first.");return}x(!0);try{const r=await chrome.runtime.sendMessage({type:"TRIGGER_MANUAL_LOOKUP",tabId:n});if(!(r!=null&&r.ok)){o((r==null?void 0:r.error)||"Could not start manual lookup.");return}o("Manual lookup requested. Highlight a sentence if needed.")}catch(r){o(r instanceof Error?r.message:"Could not start manual lookup.")}finally{x(!1),window.setTimeout(()=>{o(h)},1800)}};return t.jsxs("main",{className:"panel-root",children:[t.jsxs("header",{className:"panel-hero",children:[t.jsxs("div",{className:"hero-top",children:[t.jsx("p",{className:"eyebrow",children:"Source Finder"}),t.jsx("p",{className:`state-chip ${j.tone}`,children:j.label})]}),t.jsx("h1",{children:"Claim Support Console"}),t.jsx("p",{className:"status-line",children:v}),e!=null&&e.claim?t.jsxs("p",{className:"claim-line",children:[t.jsx("span",{children:"Claim"}),e.claim]}):null,e!=null&&e.updatedAt?t.jsxs("div",{className:"meta-row",children:[e.site?t.jsx("p",{className:"meta-pill",children:e.site}):null,t.jsxs("p",{className:"meta-pill",children:["Updated ",E(e.updatedAt)]})]}):null]}),t.jsxs("section",{className:"control-row",children:[t.jsx("button",{type:"button",className:"control primary",onClick:()=>{w()},disabled:n===null||f,children:f?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"button-spinner","aria-hidden":"true"}),"Requesting..."]}):"Lookup Selected Text"}),t.jsx("button",{type:"button",className:"control ghost-control",onClick:()=>{chrome.runtime.openOptionsPage()},children:"Options"})]}),(e==null?void 0:e.status)==="loading"?t.jsxs("div",{className:"loading-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{className:"spinner","aria-hidden":"true"}),t.jsx("p",{children:"Searching OpenAlex and Crossref..."})]}):null,(e==null?void 0:e.status)==="error"?t.jsx("div",{className:"error-state",role:"status","aria-live":"polite",children:t.jsx("p",{children:e.error||"Could not load source suggestions."})}):null,(e==null?void 0:e.status)==="loading"?t.jsxs("div",{className:"loading-stack","aria-hidden":"true",children:[t.jsx("div",{className:"skeleton"}),t.jsx("div",{className:"skeleton"}),t.jsx("div",{className:"skeleton"})]}):null,S?t.jsx("section",{className:"source-grid",children:e.suggestions.map(r=>t.jsx(I,{suggestion:r,onCopied:i=>{o(i),window.setTimeout(()=>{o(h)},1500)}},r.id))}):null,(e==null?void 0:e.status)==="ready"&&e.suggestions.length===0?t.jsx(N,{title:"No strong matches yet",description:"Try a longer sentence or use Lookup Selected Text."}):null,(e==null?void 0:e.status)==="idle"||!e?t.jsx(N,{title:"Waiting for a claim",description:"Type a sentence ending with punctuation, or highlight one and click Lookup Selected Text."}):null]})}const g=document.getElementById("root");if(!g)throw new Error("Missing #root element for side panel.");T(g).render(t.jsx(k.StrictMode,{children:t.jsx(U,{})}));
