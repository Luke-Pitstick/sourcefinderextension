import{r as o,j as t,c as T,R as w}from"./client-B9F7oGqJ.js";const h="Listening for claims...";async function k(){var e;const s=(e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:e.id;return Number.isInteger(s)?s:null}async function y(n){return await navigator.clipboard.writeText(n),"Copied to clipboard."}function C(n){const s=Math.round(n*100);return s>=80?`High ${s}%`:s>=65?`Medium ${s}%`:`Low ${s}%`}function L(n){return n>=.8?"high":n>=.65?"medium":"low"}function A(n){return new Date(n).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}function E({suggestion:n,onCopied:s}){const e=n.authors.length>0?n.authors.join(", "):"Unknown authors",u=[n.venue,n.year].filter(Boolean).join(" • ")||"Unknown venue";return t.jsxs("article",{className:"source-card",children:[t.jsxs("header",{children:[t.jsx("p",{className:`confidence-pill ${L(n.confidence)}`,children:C(n.confidence)}),t.jsx("h3",{children:n.title}),t.jsx("p",{className:"source-meta",children:e}),t.jsx("p",{className:"source-meta muted",children:u})]}),n.why?t.jsxs("p",{className:"why",children:["Why: ",n.why]}):null,n.abstractSnippet?t.jsx("p",{className:"abstract",children:n.abstractSnippet.slice(0,260)}):null,t.jsxs("div",{className:"actions",children:[t.jsx("button",{type:"button",onClick:()=>{y(n.inTextCitation).then(s)},children:"Copy In-Text"}),t.jsx("button",{type:"button",onClick:()=>{y(n.bibliographyCitation).then(s)},children:"Copy Reference"}),t.jsx("button",{type:"button",className:"ghost",onClick:()=>{chrome.tabs.create({url:n.url})},children:"Open Source"})]})]})}function b({description:n}){return t.jsx("div",{className:"empty-state",children:t.jsx("p",{children:n})})}function M(){const[n,s]=o.useState(null),[e,u]=o.useState(null),[m,a]=o.useState(h),[f,x]=o.useState(!1),p=o.useRef(null);o.useEffect(()=>{const r=chrome.runtime.connect({name:"SIDEPANEL"});p.current=r;const i=c=>{c.type!=="SUGGESTIONS_UPDATED"||!c.payload||n!==null&&c.payload.tabId!==n||u(c.payload)};return r.onMessage.addListener(i),()=>{r.onMessage.removeListener(i),r.disconnect(),p.current=null}},[n]),o.useEffect(()=>{const r=async()=>{var j;const l=await k();if(s(l),l===null){u(null);return}(j=p.current)==null||j.postMessage({type:"SUBSCRIBE_TAB",tabId:l});const d=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:l});d&&u(d)};r();const i=()=>{r()},c=(l,d)=>{d.status==="complete"&&l===n&&r()};return chrome.tabs.onActivated.addListener(i),chrome.tabs.onUpdated.addListener(c),()=>{chrome.tabs.onActivated.removeListener(i),chrome.tabs.onUpdated.removeListener(c)}},[n]);const v=o.useMemo(()=>e?e.status==="loading"?"Searching for supporting sources...":e.status==="error"?e.error||"Could not load source suggestions.":e.status==="ready"&&e.suggestions.length===0?"No confident sources found for the latest claim.":e.status==="ready"?`Found ${e.suggestions.length} sources for the latest claim.`:e.status==="idle"&&e.error?e.error:m:"Open Google Docs or Word web to start.",[e,m]),g=(e==null?void 0:e.status)==="ready"&&e.suggestions.length>0,S=async()=>{if(n===null){a("Open a Docs or Word tab first.");return}x(!0);try{const r=await chrome.runtime.sendMessage({type:"TRIGGER_MANUAL_LOOKUP",tabId:n});if(!(r!=null&&r.ok)){a((r==null?void 0:r.error)||"Could not start manual lookup.");return}a("Manual lookup requested. Highlight a sentence if needed.")}catch(r){a(r instanceof Error?r.message:"Could not start manual lookup.")}finally{x(!1),window.setTimeout(()=>{a(h)},1800)}};return t.jsxs("main",{className:"panel-root",children:[t.jsxs("header",{className:"panel-hero",children:[t.jsx("p",{className:"eyebrow",children:"Source Finder"}),t.jsx("h1",{children:"Claim Support Console"}),t.jsx("p",{className:"status-line",children:v}),e!=null&&e.claim?t.jsxs("p",{className:"claim-line",children:["Claim: ",e.claim]}):null,e!=null&&e.updatedAt?t.jsxs("p",{className:"meta-line",children:[e.site?`${e.site} • `:"","Updated ",A(e.updatedAt)]}):null]}),t.jsxs("section",{className:"control-row",children:[t.jsx("button",{type:"button",className:"control primary",onClick:()=>{S()},disabled:n===null||f,children:f?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"button-spinner","aria-hidden":"true"}),"Requesting..."]}):"Lookup Selected Text"}),t.jsx("button",{type:"button",className:"control ghost-control",onClick:()=>{chrome.runtime.openOptionsPage()},children:"Options"})]}),(e==null?void 0:e.status)==="loading"?t.jsxs("div",{className:"loading-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{className:"spinner","aria-hidden":"true"}),t.jsx("p",{children:"Searching OpenAlex and Crossref..."})]}):null,(e==null?void 0:e.status)==="error"?t.jsx("div",{className:"error-state",role:"status","aria-live":"polite",children:t.jsx("p",{children:e.error||"Could not load source suggestions."})}):null,(e==null?void 0:e.status)==="loading"?t.jsxs("div",{className:"loading-stack","aria-hidden":"true",children:[t.jsx("div",{className:"skeleton"}),t.jsx("div",{className:"skeleton"}),t.jsx("div",{className:"skeleton"})]}):null,g?t.jsx("section",{className:"source-grid",children:e.suggestions.map(r=>t.jsx(E,{suggestion:r,onCopied:i=>{a(i),window.setTimeout(()=>{a(h)},1500)}},r.id))}):null,(e==null?void 0:e.status)==="ready"&&e.suggestions.length===0?t.jsx(b,{description:"No confident match yet. Try a longer sentence or use Lookup Selected Text."}):null,(e==null?void 0:e.status)==="idle"||!e?t.jsx(b,{description:"Type a sentence ending with punctuation, or highlight one and click Lookup Selected Text."}):null]})}const N=document.getElementById("root");if(!N)throw new Error("Missing #root element for side panel.");T(N).render(t.jsx(w.StrictMode,{children:t.jsx(M,{})}));
