import{g as _,D as P}from"./storage-NNWWAa_K.js";const b=25,x=280,C=20;function U(t){return t.replace(/\s+/g," ").trim()}function v(t,e){const n=e==="manual"?C:b;return t.length>=n&&t.length<=x}function B(t){return t==="manual"?C:b}function q(t,e,n){return`${e}::${n}::${t.toLowerCase()}`}const R=2*60*1e3,F="assets/contentMain.js",p=new Map,y=new Map,T=new Map,g=new Map,A=new Map,d=new Map;function k(t){return t instanceof Error&&t.message?t.message:typeof t=="string"?t:""}function H(t){const e=k(t);return e.includes("Receiving end does not exist")||e.includes("Could not establish connection")}function $(t){return t?t.startsWith("https://docs.google.com/document/")||t.startsWith("https://word.office.com/"):!1}function I(t){const e=k(t);return e?e.includes("Cannot access contents of url")||e.includes("Missing host permission")?"Grant Source Finder site access for docs.google.com/word.office.com in extension details.":e:"Could not trigger manual lookup on this page."}function K(t){const e=t;return!!e&&e.type==="CLAIM_CANDIDATE"&&typeof e.claim=="string"&&(e.mode==="auto"||e.mode==="manual")&&(e.site==="google-docs"||e.site==="word-web")}function j(t){const e=t;return!!e&&e.type==="MANUAL_LOOKUP_EMPTY"&&(e.site==="google-docs"||e.site==="word-web")}function z(t){const e=t;return!!e&&e.type==="TRIGGER_MANUAL_LOOKUP"}function W(t){return{tabId:t,status:"idle",claim:"",site:null,suggestions:[],error:null,requestId:0,updatedAt:Date.now()}}function i(t){const e=p.get(t);if(e)return e;const n=W(t);return p.set(t,n),n}function l(t,e){const n={...i(t),...e,tabId:t,updatedAt:Date.now()};return p.set(t,n),Q(t,n),n}function Q(t,e){const n=d.get(t);if(!(!n||n.size===0))for(const r of n)try{r.postMessage({type:"SUGGESTIONS_UPDATED",payload:e})}catch{}}function G(t){const e=y.get(t);e&&(clearTimeout(e),y.delete(t))}async function E(t){await chrome.tabs.sendMessage(t,{type:"MANUAL_LOOKUP_REQUEST"})}async function J(t){await chrome.scripting.executeScript({target:{tabId:t,allFrames:!0},files:[F]})}async function O(t){const e=await chrome.tabs.get(t);$(e.url)&&await J(t)}async function D(t){try{await E(t);return}catch(e){if(!H(e))throw e}await O(t),await E(t)}async function N(t,e){const n=await _(),r=U(e.claim),s=i(t);if(!v(r,e.mode)){const u=B(e.mode),f=e.mode==="manual"?"Selected text":"Claim";l(t,{status:"idle",site:e.site,claim:r,suggestions:[],error:`${f} is too short. Use at least ${u} characters.`});return}if(e.mode==="auto"&&r===s.claim)return;const a=q(r,n.style,n.maxResults),o=A.get(a);if(o&&o.expiresAt>Date.now()){l(t,{status:"ready",site:e.site,claim:r,error:null,suggestions:o.suggestions});return}const c=s.requestId+1;l(t,{status:"loading",site:e.site,claim:r,error:null,requestId:c});const m=g.get(t);m&&m.abort();const h=new AbortController;g.set(t,h);const S=new URL("/api/sources/suggest",n.apiBaseUrl).toString(),L={claim:r,style:n.style,maxResults:n.maxResults};n.debugMode&&console.info("[sourcefinder] REQUEST_SUGGESTIONS",{tabId:t,endpoint:S,requestBody:L});try{const u=await fetch(S,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(L),signal:h.signal}),f=await u.json();if(!u.ok)throw new Error(f.error||`Lookup failed (HTTP ${u.status})`);if(i(t).requestId!==c)return;const M=Array.isArray(f.suggestions)?f.suggestions:[];A.set(a,{suggestions:M,expiresAt:Date.now()+R}),l(t,{status:"ready",claim:r,site:e.site,suggestions:M,error:null})}catch(u){if(h.signal.aborted||i(t).requestId!==c)return;l(t,{status:"error",claim:r,site:e.site,suggestions:[],error:u instanceof Error?u.message:"Lookup failed."})}finally{g.get(t)===h&&g.delete(t)}}async function V(t,e){const n=await _();if(T.set(t,e),G(t),e.mode==="manual"){N(t,e);return}const r=Number.isFinite(n.debounceMs)?Math.max(300,n.debounceMs):P.debounceMs,s=setTimeout(()=>{const a=T.get(t);a&&N(t,a)},r);y.set(t,s)}async function w(){var n;const e=(n=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:n.id;return Number.isInteger(e)?e:null}chrome.runtime.onInstalled.addListener(()=>{chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})});chrome.runtime.onConnect.addListener(t=>{if(t.name!=="SIDEPANEL")return;let e=null;t.onMessage.addListener(n=>{if(!n||n.type!=="SUBSCRIBE_TAB"||!Number.isInteger(n.tabId))return;if(e!==null){const s=d.get(e);s==null||s.delete(t)}e=n.tabId;const r=d.get(n.tabId)||new Set;r.add(t),d.set(n.tabId,r),O(n.tabId).catch(()=>{}),t.postMessage({type:"SUGGESTIONS_UPDATED",payload:i(n.tabId)})}),t.onDisconnect.addListener(()=>{if(e===null)return;const n=d.get(e);n==null||n.delete(t),(!n||n.size===0)&&d.delete(e)})});chrome.runtime.onMessage.addListener((t,e,n)=>{var s,a;const r=t;if(K(t)){const o=(s=e.tab)==null?void 0:s.id;if(!Number.isInteger(o))return;const c=U(t.claim);if(!c)return;V(o,{claim:c,mode:t.mode,site:t.site});return}if(j(t)){const o=(a=e.tab)==null?void 0:a.id;if(!Number.isInteger(o))return;l(o,{status:"idle",site:t.site,suggestions:[],error:"No selected sentence found. Highlight a sentence, then run manual lookup."});return}if(z(t))return(async()=>{const o=Number.isInteger(t.tabId)?t.tabId:await w();if(o===null){n({ok:!1,error:"No active tab was found."});return}try{await D(o),n({ok:!0})}catch(c){const m=I(c);l(o,{status:"idle",site:i(o).site,suggestions:[],error:m}),n({ok:!1,error:m})}})(),!0;if((r==null?void 0:r.type)==="GET_TAB_STATE"&&Number.isInteger(r.tabId)){n(i(r.tabId));return}if((r==null?void 0:r.type)==="GET_ACTIVE_TAB_STATE")return(async()=>{try{const o=await w();if(o===null){n(null);return}n(i(o))}catch{n(null)}})(),!0});chrome.commands.onCommand.addListener(async t=>{if(t!=="manual-lookup")return;const e=await w();if(e!==null)try{await D(e)}catch(n){const r=I(n);l(e,{status:"idle",site:i(e).site,suggestions:[],error:r})}});chrome.tabs.onRemoved.addListener(t=>{var e;G(t),T.delete(t),(e=g.get(t))==null||e.abort(),g.delete(t),p.delete(t),d.delete(t)});
