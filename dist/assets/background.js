import{g as N,D as I}from"./storage-NNWWAa_K.js";const _=25,D=280,b=20;function C(t){return t.replace(/\s+/g," ").trim()}function G(t,e){const n=e==="manual"?b:_;return t.length>=n&&t.length<=D}function O(t){return t==="manual"?b:_}function v(t,e,n){return`${e}::${n}::${t.toLowerCase()}`}const P=2*60*1e3,y=new Map,T=new Map,h=new Map,f=new Map,E=new Map,d=new Map;function B(t){const e=t;return!!e&&e.type==="CLAIM_CANDIDATE"&&typeof e.claim=="string"&&(e.mode==="auto"||e.mode==="manual")&&(e.site==="google-docs"||e.site==="word-web")}function q(t){const e=t;return!!e&&e.type==="MANUAL_LOOKUP_EMPTY"&&(e.site==="google-docs"||e.site==="word-web")}function x(t){const e=t;return!!e&&e.type==="TRIGGER_MANUAL_LOOKUP"}function H(t){return{tabId:t,status:"idle",claim:"",site:null,suggestions:[],error:null,requestId:0,updatedAt:Date.now()}}function a(t){const e=y.get(t);if(e)return e;const n=H(t);return y.set(t,n),n}function l(t,e){const n={...a(t),...e,tabId:t,updatedAt:Date.now()};return y.set(t,n),$(t,n),n}function $(t,e){const n=d.get(t);if(!(!n||n.size===0))for(const r of n)try{r.postMessage({type:"SUGGESTIONS_UPDATED",payload:e})}catch{}}function U(t){const e=T.get(t);e&&(clearTimeout(e),T.delete(t))}async function k(t){await chrome.tabs.sendMessage(t,{type:"MANUAL_LOOKUP_REQUEST"})}async function M(t,e){const n=await N(),r=C(e.claim),s=a(t);if(!G(r,e.mode)){const c=O(e.mode),g=e.mode==="manual"?"Selected text":"Claim";l(t,{status:"idle",site:e.site,claim:r,suggestions:[],error:`${g} is too short. Use at least ${c} characters.`});return}if(e.mode==="auto"&&r===s.claim)return;const u=v(r,n.style,n.maxResults),o=E.get(u);if(o&&o.expiresAt>Date.now()){l(t,{status:"ready",site:e.site,claim:r,error:null,suggestions:o.suggestions});return}const i=s.requestId+1;l(t,{status:"loading",site:e.site,claim:r,error:null,requestId:i});const A=f.get(t);A&&A.abort();const m=new AbortController;f.set(t,m);const S=new URL("/api/sources/suggest",n.apiBaseUrl).toString(),w={claim:r,style:n.style,maxResults:n.maxResults};n.debugMode&&console.info("[sourcefinder] REQUEST_SUGGESTIONS",{tabId:t,endpoint:S,requestBody:w});try{const c=await fetch(S,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(w),signal:m.signal}),g=await c.json();if(!c.ok)throw new Error(g.error||`Lookup failed (HTTP ${c.status})`);if(a(t).requestId!==i)return;const L=Array.isArray(g.suggestions)?g.suggestions:[];E.set(u,{suggestions:L,expiresAt:Date.now()+P}),l(t,{status:"ready",claim:r,site:e.site,suggestions:L,error:null})}catch(c){if(m.signal.aborted||a(t).requestId!==i)return;l(t,{status:"error",claim:r,site:e.site,suggestions:[],error:c instanceof Error?c.message:"Lookup failed."})}finally{f.get(t)===m&&f.delete(t)}}async function K(t,e){const n=await N();if(h.set(t,e),U(t),e.mode==="manual"){M(t,e);return}const r=Number.isFinite(n.debounceMs)?Math.max(300,n.debounceMs):I.debounceMs,s=setTimeout(()=>{const u=h.get(t);u&&M(t,u)},r);T.set(t,s)}async function p(){var n;const e=(n=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:n.id;return Number.isInteger(e)?e:null}chrome.runtime.onInstalled.addListener(()=>{chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})});chrome.runtime.onConnect.addListener(t=>{if(t.name!=="SIDEPANEL")return;let e=null;t.onMessage.addListener(n=>{if(!n||n.type!=="SUBSCRIBE_TAB"||!Number.isInteger(n.tabId))return;if(e!==null){const s=d.get(e);s==null||s.delete(t)}e=n.tabId;const r=d.get(n.tabId)||new Set;r.add(t),d.set(n.tabId,r),t.postMessage({type:"SUGGESTIONS_UPDATED",payload:a(n.tabId)})}),t.onDisconnect.addListener(()=>{if(e===null)return;const n=d.get(e);n==null||n.delete(t),(!n||n.size===0)&&d.delete(e)})});chrome.runtime.onMessage.addListener((t,e,n)=>{var s,u;const r=t;if(B(t)){const o=(s=e.tab)==null?void 0:s.id;if(!Number.isInteger(o))return;const i=C(t.claim);if(!i)return;K(o,{claim:i,mode:t.mode,site:t.site});return}if(q(t)){const o=(u=e.tab)==null?void 0:u.id;if(!Number.isInteger(o))return;l(o,{status:"idle",site:t.site,suggestions:[],error:"No selected sentence found. Highlight a sentence, then run manual lookup."});return}if(x(t))return(async()=>{const o=Number.isInteger(t.tabId)?t.tabId:await p();if(o===null){n({ok:!1,error:"No active tab was found."});return}try{await k(o),n({ok:!0})}catch(i){l(o,{status:"idle",site:a(o).site,suggestions:[],error:i instanceof Error?i.message:"Could not trigger manual lookup on this page."}),n({ok:!1,error:i instanceof Error?i.message:"Could not trigger manual lookup on this page."})}})(),!0;if((r==null?void 0:r.type)==="GET_TAB_STATE"&&Number.isInteger(r.tabId)){n(a(r.tabId));return}if((r==null?void 0:r.type)==="GET_ACTIVE_TAB_STATE")return(async()=>{try{const o=await p();if(o===null){n(null);return}n(a(o))}catch{n(null)}})(),!0});chrome.commands.onCommand.addListener(async t=>{if(t!=="manual-lookup")return;const e=await p();if(e!==null)try{await k(e)}catch(n){l(e,{status:"idle",site:a(e).site,suggestions:[],error:n instanceof Error?n.message:"Could not trigger manual lookup on this page."})}});chrome.tabs.onRemoved.addListener(t=>{var e;U(t),h.delete(t),(e=f.get(t))==null||e.abort(),f.delete(t),y.delete(t),d.delete(t)});
