import{g as C,D}from"./storage-NNWWAa_K.js";const _=25,x=280,b=20;function U(e){return e.replace(/\s+/g," ").trim()}function B(e,t){const n=t==="manual"?b:_;return e.length>=n&&e.length<=x}function R(e){return e==="manual"?b:_}function q(e,t,n){return`${t}::${n}::${e.toLowerCase()}`}const F=2*60*1e3,H="assets/contentMain.js",p=new Map,y=new Map,w=new Map,g=new Map,E=new Map,d=new Map;function k(e){return e instanceof Error&&e.message?e.message:typeof e=="string"?e:""}function I(e){const t=k(e);return t.includes("Receiving end does not exist")||t.includes("Could not establish connection")||t.includes("The message port closed before a response was received")||t.includes("message channel closed before a response was received")}function $(e){return e?e.startsWith("https://docs.google.com/document/")||e.startsWith("https://word.office.com/"):!1}function G(e){const t=k(e);return t?t.includes("Cannot access contents of url")||t.includes("Missing host permission")?"Grant Source Finder site access for docs.google.com/word.office.com in extension details.":t:"Could not trigger manual lookup on this page."}function K(e){const t=e;return!!t&&t.type==="CLAIM_CANDIDATE"&&typeof t.claim=="string"&&(t.mode==="auto"||t.mode==="manual")&&(t.site==="google-docs"||t.site==="word-web")}function j(e){const t=e;return!!t&&t.type==="MANUAL_LOOKUP_EMPTY"&&(t.site==="google-docs"||t.site==="word-web")}function z(e){const t=e;return!!t&&t.type==="TRIGGER_MANUAL_LOOKUP"}function W(e){return{tabId:e,status:"idle",claim:"",site:null,suggestions:[],error:null,requestId:0,updatedAt:Date.now()}}function i(e){const t=p.get(e);if(t)return t;const n=W(e);return p.set(e,n),n}function l(e,t){const n={...i(e),...t,tabId:e,updatedAt:Date.now()};return p.set(e,n),Q(e,n),n}function Q(e,t){const n=d.get(e);if(!(!n||n.size===0))for(const r of n)try{r.postMessage({type:"SUGGESTIONS_UPDATED",payload:t})}catch{}}function O(e){const t=y.get(e);t&&(clearTimeout(t),y.delete(e))}async function A(e){await chrome.tabs.sendMessage(e,{type:"MANUAL_LOOKUP_REQUEST"})}async function J(e){try{const t=await chrome.tabs.sendMessage(e,{type:"PING_CONTENT_SCRIPT"});return!!(t!=null&&t.ok)}catch(t){if(I(t))return!1;throw t}}async function V(e){await J(e)||await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:[H]})}async function P(e){const t=await chrome.tabs.get(e);$(t.url)&&await V(e)}async function v(e){try{await A(e);return}catch(t){if(!I(t))throw t}await P(e),await A(e)}async function N(e,t){const n=await C(),r=U(t.claim),s=i(e);if(!B(r,t.mode)){const u=R(t.mode),f=t.mode==="manual"?"Selected text":"Claim";l(e,{status:"idle",site:t.site,claim:r,suggestions:[],error:`${f} is too short. Use at least ${u} characters.`});return}if(t.mode==="auto"&&r===s.claim)return;const a=q(r,n.style,n.maxResults),o=E.get(a);if(o&&o.expiresAt>Date.now()){l(e,{status:"ready",site:t.site,claim:r,error:null,suggestions:o.suggestions});return}const c=s.requestId+1;l(e,{status:"loading",site:t.site,claim:r,error:null,requestId:c});const m=g.get(e);m&&m.abort();const h=new AbortController;g.set(e,h);const S=new URL("/api/sources/suggest",n.apiBaseUrl).toString(),M={claim:r,style:n.style,maxResults:n.maxResults};n.debugMode&&console.info("[sourcefinder] REQUEST_SUGGESTIONS",{tabId:e,endpoint:S,requestBody:M});try{const u=await fetch(S,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(M),signal:h.signal}),f=await u.json();if(!u.ok)throw new Error(f.error||`Lookup failed (HTTP ${u.status})`);if(i(e).requestId!==c)return;const L=Array.isArray(f.suggestions)?f.suggestions:[];E.set(a,{suggestions:L,expiresAt:Date.now()+F}),l(e,{status:"ready",claim:r,site:t.site,suggestions:L,error:null})}catch(u){if(h.signal.aborted||i(e).requestId!==c)return;l(e,{status:"error",claim:r,site:t.site,suggestions:[],error:u instanceof Error?u.message:"Lookup failed."})}finally{g.get(e)===h&&g.delete(e)}}async function X(e,t){const n=await C();if(w.set(e,t),O(e),t.mode==="manual"){N(e,t);return}const r=Number.isFinite(n.debounceMs)?Math.max(300,n.debounceMs):D.debounceMs,s=setTimeout(()=>{const a=w.get(e);a&&N(e,a)},r);y.set(e,s)}async function T(){var n;const t=(n=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:n.id;return Number.isInteger(t)?t:null}chrome.runtime.onInstalled.addListener(()=>{chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})});chrome.runtime.onConnect.addListener(e=>{if(e.name!=="SIDEPANEL")return;let t=null;e.onMessage.addListener(n=>{if(!n||n.type!=="SUBSCRIBE_TAB"||!Number.isInteger(n.tabId))return;if(t!==null){const s=d.get(t);s==null||s.delete(e)}t=n.tabId;const r=d.get(n.tabId)||new Set;r.add(e),d.set(n.tabId,r),P(n.tabId).catch(()=>{}),e.postMessage({type:"SUGGESTIONS_UPDATED",payload:i(n.tabId)})}),e.onDisconnect.addListener(()=>{if(t===null)return;const n=d.get(t);n==null||n.delete(e),(!n||n.size===0)&&d.delete(t)})});chrome.runtime.onMessage.addListener((e,t,n)=>{var s,a;const r=e;if(K(e)){const o=(s=t.tab)==null?void 0:s.id;if(!Number.isInteger(o))return;const c=U(e.claim);if(!c)return;X(o,{claim:c,mode:e.mode,site:e.site});return}if(j(e)){const o=(a=t.tab)==null?void 0:a.id;if(!Number.isInteger(o))return;l(o,{status:"idle",site:e.site,suggestions:[],error:"No selected sentence found. Highlight a sentence, then run manual lookup."});return}if(z(e))return(async()=>{const o=Number.isInteger(e.tabId)?e.tabId:await T();if(o===null){n({ok:!1,error:"No active tab was found."});return}try{await v(o),n({ok:!0})}catch(c){const m=G(c);l(o,{status:"idle",site:i(o).site,suggestions:[],error:m}),n({ok:!1,error:m})}})(),!0;if((r==null?void 0:r.type)==="GET_TAB_STATE"&&Number.isInteger(r.tabId)){n(i(r.tabId));return}if((r==null?void 0:r.type)==="GET_ACTIVE_TAB_STATE")return(async()=>{try{const o=await T();if(o===null){n(null);return}n(i(o))}catch{n(null)}})(),!0});chrome.commands.onCommand.addListener(async e=>{if(e!=="manual-lookup")return;const t=await T();if(t!==null)try{await v(t)}catch(n){const r=G(n);l(t,{status:"idle",site:i(t).site,suggestions:[],error:r})}});chrome.tabs.onRemoved.addListener(e=>{var t;O(e),w.delete(e),(t=g.get(e))==null||t.abort(),g.delete(e),p.delete(e),d.delete(e)});
